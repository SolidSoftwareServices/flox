name: $(rev:.r)

trigger: none

pool:
  name: YAML
  demands:
  - java
  - vstest

variables: 
  BuildConfiguration: Release
  Parameters.ArtifactName: WebApp

jobs:
- job: IntegrationTests
  steps:
  - task: DotNetCoreCLI@2
    displayName: 'Run Integration Tests'
    inputs:
      command: test
      projects: '**/*.IntegrationTests/*.csproj'
      arguments: '--configuration $(BuildConfiguration) --collect "Code Coverage"'

- job: UnitTests
  steps:
  - task: DotNetCoreCLI@2
    displayName: 'Run Unit Tests'
    inputs:
      command: test
      projects: '**/*.UnitTests/*.csproj'
      arguments: '--configuration $(BuildConfiguration) --collect "Code Coverage"'

- job: Build
  steps:
  - task: PowerShell@2
    displayName: 'PowerShell Script'
    inputs:
      targetType: filePath
      filePath: './build/versionNumber.ps1'
    
  - task: NuGetToolInstaller@0
    displayName: 'Use NuGet 4.4.1'
    inputs:
      versionSpec: 4.4.1

  - task: NuGetCommand@2
    displayName: 'NuGet restore'

  - task: DotNetCoreCLI@2
    displayName: Build
    inputs:
      projects: '**/*.sln'
      arguments: '--configuration $(BuildConfiguration) /p:Version=$(Build.BuildNumber)'

  - task: DotNetCoreCLI@2
    displayName: 'dotnet publish'
    inputs:
      command: publish
      publishWebProjects: false
      projects: '**/EI.RP.WebApp.csproj'
      arguments: '--configuration $(BuildConfiguration) --output "$(Build.ArtifactStagingDirectory)" --no-build --no-restore'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish WebApp Artifact'
    inputs:
      PathtoPublish: '$(build.artifactstagingdirectory)/EI.RP.WebApp.zip'
      ArtifactName: '$(Parameters.ArtifactName)'

  - task: DeleteFiles@1
    displayName: 'Remove unused files for Test Artifact'
    inputs:
      SourceFolder: src/EI.RP.WebApp.AcceptanceTests/bin/Release/
      Contents: chromedriver.exe

  - task: ArchiveFiles@2
    displayName: 'Zip UI Test Artifact'
    inputs:
      rootFolderOrFile: src/EI.RP.WebApp.AcceptanceTests/bin/Release
      includeRootFolder: false
      archiveFile: '$(Build.ArtifactStagingDirectory)/Tests.zip'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish UI Test Artifact'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/Tests.zip'
      ArtifactName: tests

  - task: ExtractFiles@1
    displayName: 'Extract files needed for IIS site'
    inputs:
      archiveFilePatterns: '$(build.artifactstagingdirectory)/EI.RP.WebApp.zip'
      destinationFolder: '$(build.artifactstagingdirectory)/Test'

  - task: WindowsMachineFileCopy@2
    displayName: 'Copy Files To staging IIS for Acceptance Testing'
    inputs:
      SourcePath: '$(build.artifactstagingdirectory)/Test'
      MachineNames: 10.80.5.79
      AdminUserName: 'CLD1\CNSLT_DeB_D'
      AdminPassword: '$(Deployment_Password)'
      TargetPath: 'D:\inetpub\wwwroot\EISmartDev'
      CleanTargetBeforeCopy: true

  - task: VSTest@2
    displayName: 'Run Acceptance Tests'
    inputs:
      testAssemblyVer2: '**\bin\Release\EI.RP.WebApp.AcceptanceTests.dll'
      testFiltercriteria: 'TestCategory=smoke'
      pathtoCustomTestAdapters: 'D:\DevSecOps VSTS Agent\vsts-agent-win-x64-2.129.1\_work\5\s\src\EI.RP.WebApp.AcceptanceTests\bin\Release'
      runInParallel: true
      rerunFailedTests: true
      rerunMaxAttempts: 2

- job: WrapUp
  dependsOn:
  - UnitTests
  - IntegrationTests
  - Build
  steps:
  - task: PowerShell@2
    displayName: 'PowerShell Script'
    inputs:
      targetType: filePath
      filePath: './build/wrapup.ps1'

